<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a2e;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            -webkit-font-smoothing: antialiased;
        }

        .wrapper {
            max-width: 650px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .email-card {
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.10);
        }

        /* ========== Header ========== */
        .header {
            padding: 40px 36px 32px;
            text-align: center;
            position: relative;
        }

        .header-critical {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .header-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .header-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .header-icon {
            font-size: 52px;
            margin-bottom: 14px;
            display: block;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
        }

        .header h1 {
            margin: 0 0 8px 0;
            font-size: 26px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.92);
            font-size: 15px;
            margin: 0;
            font-weight: 500;
        }

        .severity-pill {
            display: inline-block;
            padding: 6px 18px;
            border-radius: 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-top: 16px;
            background: rgba(255, 255, 255, 0.25);
            color: #ffffff;
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }

        /* ========== Quick Info Banner ========== */
        .info-banner {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 36px;
        }

        .info-grid {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }

        .info-item {
            display: table-cell;
            width: 33.33%;
            padding: 0 12px;
            text-align: center;
            border-right: 1px solid #e2e8f0;
        }

        .info-item:first-child {
            padding-left: 0;
        }

        .info-item:last-child {
            border-right: none;
            padding-right: 0;
        }

        .info-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #64748b;
            margin-bottom: 6px;
        }

        .info-value {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            word-break: break-word;
        }

        /* ========== Body Content ========== */
        .body {
            padding: 32px 36px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #475569;
            margin: 0 0 14px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            align-items: center;
        }

        .section-title-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        /* ========== Description Box ========== */
        .description-box {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px 24px;
            border-left: 4px solid #3b82f6;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .description-box-critical {
            border-left-color: #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .description-box-warning {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .description-text {
            font-size: 16px;
            color: #1e293b;
            margin: 0;
            line-height: 1.75;
            font-weight: 500;
        }

        .description-text::before {
            content: "üìã";
            margin-right: 10px;
            font-size: 18px;
        }

        /* ========== Schema Summary Stats ========== */
        .schema-summary {
            display: table;
            width: 100%;
            margin-bottom: 24px;
            border-collapse: collapse;
        }

        .schema-stat {
            display: table-cell;
            width: 33.33%;
            padding: 20px 16px;
            text-align: center;
            border-radius: 10px;
            border: 2px solid;
        }

        .schema-stat-critical {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fecaca;
        }

        .schema-stat-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fde68a;
            margin: 0 8px;
        }

        .schema-stat-info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #bfdbfe;
        }

        .schema-stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .schema-stat-number {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }

        .schema-stat-critical .schema-stat-number {
            color: #991b1b;
        }

        .schema-stat-warning .schema-stat-number {
            color: #92400e;
        }

        .schema-stat-info .schema-stat-number {
            color: #1e40af;
        }

        .schema-stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
        }

        /* ========== Changes Groups ========== */
        .changes-group {
            margin-bottom: 20px;
        }

        .changes-group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 0;
        }

        .changes-group-header-critical {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fecaca;
            border-bottom: none;
        }

        .changes-group-header-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fde68a;
            border-bottom: none;
        }

        .changes-group-header-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #bfdbfe;
            border-bottom: none;
        }

        .changes-group-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .changes-group-title {
            flex: 1;
        }

        /* ========== Compact Changes List ========== */
        .compact-changes {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            padding: 12px 16px;
        }

        .compact-change-item {
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compact-change-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .compact-change-column {
            font-weight: 600;
            font-family: 'SF Mono', 'Consolas', monospace;
            color: #1e293b;
            min-width: 120px;
        }

        .compact-change-arrow {
            color: #94a3b8;
            font-weight: 700;
        }

        .compact-change-detail {
            color: #475569;
            flex: 1;
        }

        .compact-change-more {
            padding: 8px 12px;
            margin-top: 8px;
            background: #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        /* ========== More Changes Notice ========== */
        .more-changes-row {
            background: #fffbeb !important;
        }

        .more-changes-notice {
            padding: 14px 16px;
            text-align: center;
            font-size: 13px;
            color: #92400e;
        }

        .inline-link {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
            margin-left: 8px;
        }

        .view-all-cta {
            text-align: center;
            margin-top: 16px;
        }

        /* ========== Schema Diff Table ========== */
        .diff-table-wrapper {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 10px 10px;
            border-top: none;
            overflow: hidden;
        }

        .diff-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .diff-table thead {
            background: #f8fafc;
        }

        .diff-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid #e2e8f0;
            color: #475569;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 700;
        }

        .diff-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: middle;
        }

        .diff-table tr:last-child td {
            border-bottom: none;
        }

        .diff-table tr:hover {
            background: #fafbfc;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-added {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-removed {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-changed {
            background: #fed7aa;
            color: #9a3412;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .diff-col-name {
            font-weight: 600;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            color: #1e293b;
            font-size: 13px;
        }

        .diff-details {
            color: #64748b;
            font-size: 12px;
        }

        /* ========== Data Comparison ========== */
        .compare-grid {
            display: table;
            width: 100%;
            border-collapse: collapse;
            gap: 16px;
        }

        .compare-col {
            display: table-cell;
            width: 50%;
            padding: 0 8px;
            vertical-align: top;
        }

        .compare-col:first-child {
            padding-left: 0;
        }

        .compare-col:last-child {
            padding-right: 0;
        }

        .compare-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .compare-expected .compare-header {
            color: #059669;
        }

        .compare-actual .compare-header {
            color: #dc2626;
        }

        .compare-box {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 16px 18px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .compare-expected .compare-box {
            border-top: 3px solid #059669;
        }

        .compare-actual .compare-box {
            border-top: 3px solid #dc2626;
        }

        /* ========== Impact Banner ========== */
        .impact-banner {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #fecaca;
            display: table;
            width: 100%;
        }

        .impact-icon-cell {
            display: table-cell;
            width: 64px;
            vertical-align: middle;
            text-align: center;
            background: #fee2e2;
        }

        .impact-icon {
            font-size: 28px;
        }

        .impact-text-cell {
            display: table-cell;
            padding: 18px 20px;
            vertical-align: middle;
        }

        .impact-title {
            color: #991b1b;
            font-size: 15px;
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .impact-desc {
            margin: 0;
            font-size: 13px;
            color: #7f1d1d;
            line-height: 1.5;
        }

        /* ========== Recommendations ========== */
        .rec-list {
            margin: 0;
            padding: 0;
            list-style: none;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .rec-list li {
            padding: 14px 18px 14px 44px;
            font-size: 14px;
            color: #475569;
            position: relative;
            border-bottom: 1px solid #e2e8f0;
        }

        .rec-list li:last-child {
            border-bottom: none;
        }

        .rec-list li::before {
            content: "‚úì";
            position: absolute;
            left: 18px;
            color: #3b82f6;
            font-weight: 700;
            font-size: 16px;
        }

        /* ========== Call-to-Action Buttons ========== */
        .cta-section {
            text-align: center;
            margin: 36px 0 8px;
            padding-top: 28px;
            border-top: 1px solid #e2e8f0;
        }

        .cta-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 14px;
            font-weight: 600;
        }

        .cta-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .cta-btn {
            display: inline-block;
            padding: 14px 32px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .cta-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .cta-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }

        /* ========== Footer ========== */
        .footer {
            background: #f8fafc;
            padding: 24px 36px;
            text-align: center;
            border-top: 1px solid #e2e8f0;
        }

        .footer-brand {
            margin: 0 0 12px;
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .footer-links {
            margin: 0 0 14px;
        }

        .footer-links a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            font-size: 12px;
            margin: 0 8px;
        }

        .footer-id {
            font-size: 11px;
            color: #94a3b8;
            font-family: 'SF Mono', 'Consolas', monospace;
            background: #f1f5f9;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
        }

        /* ========== Mobile Responsive ========== */
        @media only screen and (max-width: 600px) {
            .wrapper {
                padding: 12px 8px;
            }

            .header {
                padding: 32px 24px 24px;
            }

            .header h1 {
                font-size: 22px;
            }

            .body {
                padding: 24px 20px;
            }

            .info-banner {
                padding: 16px 20px;
            }

            .info-item {
                display: block;
                width: 100%;
                padding: 12px 0;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }

            .info-item:last-child {
                border-bottom: none;
            }

            .compare-col {
                display: block;
                width: 100%;
                padding: 0;
                margin-bottom: 16px;
            }

            .cta-row {
                flex-direction: column;
            }

            .cta-btn {
                width: 100%;
            }

            /* Schema Summary Mobile */
            .schema-stat {
                display: block;
                width: 100%;
                margin: 0 0 12px 0 !important;
                padding: 16px;
            }

            .schema-stat:last-child {
                margin-bottom: 0 !important;
            }

            .schema-stat-number {
                font-size: 28px;
            }

            /* Compact Changes Mobile */
            .compact-change-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .compact-change-column {
                min-width: auto;
            }

            .compact-change-arrow {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="email-card">

            <!-- ===== HEADER ===== -->
            <div class="header header-{{ severity|lower }}">
                <span class="header-icon">
                    {% if severity|lower == 'critical' %}üö®{% elif severity|lower == 'warning' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif
                    %}
                </span>
                <h1>{{ anomaly_type_display }}</h1>
                <p class="header-subtitle">Detected in dataset <strong>{{ dataset_name }}</strong></p>
                <span class="severity-pill">{{ severity }} Alert</span>
            </div>

            <!-- ===== QUICK INFO BANNER ===== -->
            <div class="info-banner">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Dataset</div>
                        <div class="info-value">{{ dataset_name }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Alert Type</div>
                        <div class="info-value">{{ anomaly_type_display }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Detected At</div>
                        <div class="info-value">{{ detected_at_display }}</div>
                    </div>
                </div>
            </div>

            <!-- ===== BODY CONTENT ===== -->
            <div class="body">

                <!-- What Happened Section -->
                <div class="section">
                    <h3 class="section-title">
                        <span class="section-title-icon">üìä</span>
                        What Happened
                    </h3>
                    <div class="description-box description-box-{{ severity|lower }}">
                        <p class="description-text">{{ description }}</p>
                    </div>
                </div>

                <!-- Schema Change Details -->
                {% if actual_value_obj and actual_value_obj.diff %}
                <div class="section">
                    <h3 class="section-title">
                        <span class="section-title-icon">üîÑ</span>
                        Schema Changes Detected
                    </h3>

                    <!-- Summary Statistics -->
                    {% set critical_changes = actual_value_obj.diff | selectattr('severity', 'equalto', 'critical') | list %}
                    {% set warning_changes = actual_value_obj.diff | selectattr('severity', 'equalto', 'warning') | list %}
                    {% set info_changes = actual_value_obj.diff | selectattr('severity', 'equalto', 'info') | list %}
                    {% set total_changes = actual_value_obj.diff | length %}

                    <div class="schema-summary">
                        <div class="schema-stat schema-stat-critical">
                            <div class="schema-stat-icon">üî¥</div>
                            <div class="schema-stat-content">
                                <div class="schema-stat-number">{{ critical_changes | length }}</div>
                                <div class="schema-stat-label">Breaking Changes</div>
                            </div>
                        </div>
                        <div class="schema-stat schema-stat-warning">
                            <div class="schema-stat-icon">üü°</div>
                            <div class="schema-stat-content">
                                <div class="schema-stat-number">{{ warning_changes | length }}</div>
                                <div class="schema-stat-label">Type Changes</div>
                            </div>
                        </div>
                        <div class="schema-stat schema-stat-info">
                            <div class="schema-stat-icon">üîµ</div>
                            <div class="schema-stat-content">
                                <div class="schema-stat-number">{{ info_changes | length }}</div>
                                <div class="schema-stat-label">Other Changes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Critical Changes (Breaking) - Always Show -->
                    {% if critical_changes %}
                    <div class="changes-group">
                        <div class="changes-group-header changes-group-header-critical">
                            <span class="changes-group-icon">‚ö†Ô∏è</span>
                            <span class="changes-group-title">Critical Changes ({{ critical_changes | length }})</span>
                        </div>
                        <div class="diff-table-wrapper">
                            <table class="diff-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">Column</th>
                                        <th>Change</th>
                                        <th style="width: 80px;">Impact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in critical_changes[:10] %}
                                    <tr>
                                        <td class="diff-col-name">{{ item.column }}</td>
                                        <td class="diff-details">
                                            {% if item.action == 'COLUMN_REMOVED' %}
                                            <strong>Removed</strong> ‚Ä¢ {{ item.details }}
                                            {% elif item.action == 'TYPE_CHANGED' %}
                                            <strong>Type changed</strong> ‚Ä¢ {{ item.details }}
                                            {% elif 'NULLABILITY' in item.action and 'NOT NULL' in item.details %}
                                            <strong>Now required</strong> ‚Ä¢ {{ item.details }}
                                            {% else %}
                                            {{ item.details }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-removed">Breaking</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if critical_changes | length > 10 %}
                                    <tr class="more-changes-row">
                                        <td colspan="3">
                                            <div class="more-changes-notice">
                                                üìã <strong>{{ critical_changes | length - 10 }} more critical changes</strong> not shown
                                                <a href="{{ dashboard_url }}/schema" class="inline-link">View all in Dashboard ‚Üí</a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Warning Changes (Type Changes) - Show Top 5 -->
                    {% if warning_changes %}
                    <div class="changes-group">
                        <div class="changes-group-header changes-group-header-warning">
                            <span class="changes-group-icon">‚ö°</span>
                            <span class="changes-group-title">Type Changes ({{ warning_changes | length }})</span>
                        </div>
                        <div class="compact-changes">
                            {% for item in warning_changes[:5] %}
                            <div class="compact-change-item">
                                <span class="compact-change-column">{{ item.column }}</span>
                                <span class="compact-change-arrow">‚Üí</span>
                                <span class="compact-change-detail">{{ item.details }}</span>
                            </div>
                            {% endfor %}
                            {% if warning_changes | length > 5 %}
                            <div class="compact-change-more">
                                + {{ warning_changes | length - 5 }} more type changes
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Info Changes (Additions, Nullability) - Collapsed Summary -->
                    {% if info_changes %}
                    <div class="changes-group">
                        <div class="changes-group-header changes-group-header-info">
                            <span class="changes-group-icon">‚ÑπÔ∏è</span>
                            <span class="changes-group-title">Non-Breaking Changes ({{ info_changes | length }})</span>
                        </div>
                        <div class="compact-changes">
                            {% set added = info_changes | selectattr('action', 'equalto', 'COLUMN_ADDED') | list %}
                            {% set nullable = info_changes | select('search', 'NULLABLE') | list %}

                            {% if added %}
                            <div class="compact-change-item">
                                <span class="badge badge-added">+ {{ added | length }}</span>
                                <span class="compact-change-detail">columns added:
                                    {% for item in added[:3] %}{{ item.column }}{% if not loop.last %}, {% endif %}{% endfor %}{% if added | length > 3 %}, +{{ added | length - 3 }} more{% endif %}
                                </span>
                            </div>
                            {% endif %}
                            {% if nullable %}
                            <div class="compact-change-item">
                                <span class="badge badge-info">‚Üª {{ nullable | length }}</span>
                                <span class="compact-change-detail">nullability changes</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- View Full Details CTA -->
                    {% if total_changes > 15 %}
                    <div class="view-all-cta">
                        <a href="{{ dashboard_url }}/schema" class="cta-btn cta-secondary" style="display: inline-block; margin-top: 12px;">
                            üìä View All {{ total_changes }} Changes in Dashboard
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% elif expected_value and actual_value %}
                <!-- Standard Expected vs Actual Comparison -->
                <div class="section">
                    <h3 class="section-title">
                        <span class="section-title-icon">‚öñÔ∏è</span>
                        Expected vs Actual Values
                    </h3>
                    <div class="compare-grid">
                        <div class="compare-col compare-expected">
                            <div class="compare-header">‚úì Expected</div>
                            <div class="compare-box">{{ expected_value }}</div>
                        </div>
                        <div class="compare-col compare-actual">
                            <div class="compare-header">‚úó Actual</div>
                            <div class="compare-box">{{ actual_value }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Impact Analysis -->
                {% if downstream_count > 0 %}
                <div class="section">
                    <div class="impact-banner">
                        <div class="impact-icon-cell">
                            <span class="impact-icon">‚ö°</span>
                        </div>
                        <div class="impact-text-cell">
                            <h4 class="impact-title">{{ downstream_count }} Downstream Dataset{{ 's' if downstream_count
                                > 1 else '' }} at Risk</h4>
                            <p class="impact-desc">This anomaly could propagate to dependent datasets. Review the
                                lineage graph to assess the blast radius and take preventive action.</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Recommended Actions -->
                <div class="section">
                    <h3 class="section-title">
                        <span class="section-title-icon">üí°</span>
                        Recommended Actions
                    </h3>
                    <ul class="rec-list">
                        {% if 'schema' in anomaly_type|lower %}
                        <li>Review the schema change and verify it was intentional and properly communicated</li>
                        <li>Update downstream consumers if field types, names, or nullability changed</li>
                        <li>Check if data pipelines need migration scripts or schema evolution handlers</li>
                        <li>Validate that existing queries and transformations still function correctly</li>
                        {% elif 'row' in anomaly_type|lower or 'volume' in anomaly_type|lower %}
                        <li>Verify that upstream data sources are running as expected</li>
                        <li>Check ETL/ELT job logs for partial failures or incomplete runs</li>
                        <li>Compare row counts with source system totals for data completeness</li>
                        <li>Review data quality rules and filtering logic for unintended changes</li>
                        {% elif 'freshness' in anomaly_type|lower or 'sla' in anomaly_type|lower %}
                        <li>Check if the pipeline job is stuck, failed, or experiencing delays</li>
                        <li>Review scheduler logs for missed triggers or execution errors</li>
                        <li>Verify network connectivity and credentials to source systems</li>
                        <li>Assess resource constraints that may be slowing down processing</li>
                        {% else %}
                        <li>Investigate the data source for unexpected changes or anomalies</li>
                        <li>Review recent pipeline deployments, config changes, or code updates</li>
                        <li>Compare current metrics with historical trends (last 7-30 days)</li>
                        <li>Check system logs and monitoring dashboards for related issues</li>
                        {% endif %}
                        <li>Examine the lineage graph to understand downstream impact</li>
                        <li>Document the root cause and resolution for future reference</li>
                    </ul>
                </div>

                <!-- Call-to-Action -->
                <div class="cta-section">
                    <div class="cta-label">Take Action Now</div>
                    <div class="cta-row">
                        <a href="{{ dashboard_url }}/anomalies" class="cta-btn cta-primary">
                            View in Dashboard ‚Üí
                        </a>
                        <a href="{{ lineage_url }}" class="cta-btn cta-secondary">
                            Explore Lineage
                        </a>
                    </div>
                </div>

            </div>

            <!-- ===== FOOTER ===== -->
            <div class="footer">
                <p class="footer-brand">
                    Automated alert from <strong>Data Observability Platform</strong>
                </p>
                <div class="footer-links">
                    <a href="{{ dashboard_url }}">Dashboard</a> ‚Ä¢
                    <a href="{{ dashboard_url }}/alerts">Alert Rules</a> ‚Ä¢
                    <a href="{{ dashboard_url }}/schema">Schema History</a>
                </div>
                <div class="footer-id">Alert ID: {{ anomaly_id }}</div>
            </div>

        </div>
    </div>
</body>

</html>